"Rock'n'Dice Core"
module RndCore:
  version: "0.8"

"Уровень"
int Level: 16

"Очки атрибутов"
int exp AttributePoints: 
    Level - sum(Attributes.values())

"Атрибуты"
obj<int> Attributes:
    "Организм"
    Organism: 0
    "Гибкость"
    Flexibility: 0
    "Интеллект"
    Intellect: 0
    "Психика"
    Psyche: 0
      
"Очки состояний"
int exp ConditionPoints: 
    Level // 2 + 1 - sum(Conditions.values())

"Состояние"
type Condition:
    "Атрибут"
    ref<int> const Attribute
    "Очки"
    int Points: 0
    "Остаток"
    int exp Balance: @Max - @Spent
    "Максимум"
    int exp Max: @Attribute * @Points
    "Потрачено"
    int Spent: 0

"Состояния"
obj<Condition> Conditions:
    "Тело"
    Body: { Attribute: Attributes.Organism }
    "Энергия"
    Energy: { Attribute: Attributes.Flexibility }
    "Разум"
    Mind: { Attribute: Attributes.Intellect }
    "Воля"
    Will: { Attribute: Attributes.Psyche }
        
"Очки профессий"
int exp ProfessionPoints: 
    Level // 2 - sum(map(lambda p: p.Points, Professions))

"Профессия"
type<int> Profession:
    "Множитель"
    const Multiplier
    "Очки"
    Points: 0
    "Модификатор"
    exp Modifier: @Points * @Multiplier

"Профессии"
obj<Profession> Professions:
    "Коронная"
    Crown: { Multiplier: 4 }
    "Основные"
    Main: { Multiplier: 3 }
    "Вспомогательные"
    Utility: { Multiplier: 2 }
    "Прочие"
    Other: { Multiplier: 1 }
    
"Очки навыков"
int exp SkillPoints: 
    Level * 2 - sum(map(lambda s: s.Points, Skills))
    
"Навык"
type Skill:
    "Атрибут"
    ref<int> const Attribute
    "Профессия"
    ref<Profession> Profession: None
    "Очки"
    int Points: 0
    
"Навыки"
obj<Skill> Skills:
    "Борьба"
    Struggle: { Attribute: Attributes.Organism }
    "Сила"
    Strength: { Attribute: Attributes.Organism }
    "Метаморфизм"
    Metamorphism: { Attribute: Attributes.Organism }
    "Блокирование"
    Blocking: { Attribute: Attributes.Organism }
    "Стойкость"
    Fortitude: { Attribute: Attributes.Organism }
    "Авторитет"
    Authority: { Attribute: Attributes.Organism }
    "Чутье"
    Flair: { Attribute: Attributes.Organism }
    "Металлургия"
    Metallurgy: { Attribute: Attributes.Organism }
    "Труд"
    Work: { Attribute: Attributes.Organism }
    "Выживание"
    Survival: { Attribute: Attributes.Organism }
    "Моторика"
    Motorics: { Attribute: Attributes.Flexibility }
    "Техника"
    Technics: { Attribute: Attributes.Flexibility }
    "Демонология"
    Demonology: { Attribute: Attributes.Flexibility }
    "Акробатика"
    Acrobatics: { Attribute: Attributes.Flexibility }
    "Выносливость"
    Endurance: { Attribute: Attributes.Flexibility }
    "Внушение"
    Inculcation: { Attribute: Attributes.Flexibility }
    "Следопытство"
    Tracking: { Attribute: Attributes.Flexibility }
    "Торговля"
    Trade: { Attribute: Attributes.Flexibility }
    "Ремесло"
    Craft: { Attribute: Attributes.Flexibility }
    "Улицы"
    Streets: { Attribute: Attributes.Flexibility }
    "Волшебство"
    Magic: { Attribute: Attributes.Intellect }
    "Некромантия"
    Necromancy: { Attribute: Attributes.Intellect }
    "Рассеивание"
    Diffusion: { Attribute: Attributes.Intellect }
    "Собранность"
    Composure: { Attribute: Attributes.Intellect }
    "Полемика"
    Controversy: { Attribute: Attributes.Intellect }
    "Исследование"
    Research: { Attribute: Attributes.Intellect }
    "Эрудиция"
    Erudition: { Attribute: Attributes.Intellect }
    "Механизмы"
    Mechanisms: { Attribute: Attributes.Intellect }
    "Зачарование"
    Enchantment: { Attribute: Attributes.Intellect }
    "Проектирование"
    Design: { Attribute: Attributes.Intellect }
    "Концентрация"
    Concentration: { Attribute: Attributes.Psyche }
    "Жречество"
    Priesthood: { Attribute: Attributes.Psyche }
    "Шаманизм"
    Shamanism: { Attribute: Attributes.Psyche }
    "Самообладание"
    SelfControl: { Attribute: Attributes.Psyche }
    "Эмпатия"
    Empathy: { Attribute: Attributes.Psyche }
    "Вдохновение"
    Inspiration: { Attribute: Attributes.Psyche }
    "Реакция"
    Reaction: { Attribute: Attributes.Psyche }
    "Алхимия"
    Alchemy: { Attribute: Attributes.Psyche }
    "Медицина"
    Medicine: { Attribute: Attributes.Psyche }
    "Выступление"
    Performance: { Attribute: Attributes.Psyche }
   
"Бросок"
type Roll:
    "Навык"
    ref<Skill> Skill
    "Кости"
    list<int> exp Dices: [randint(-16, 3), randint(-16, 3), randint(-16, 3)]
    "Криты"
    int exp Crits: sum(dice == 3 for dice in @Dices)
    "Мисскриты"
    int exp Misscrits: sum(dice == -16 for dice in @Dices)
    "Модификатор критов"
    int exp Critvalue: sum(randint(1, 6) * 1 if i > 0 else -1 if i < 0 else 0 for i in range(@Misscrits, @Crits))
    "Значение атрибута"
    int exp AttributeValue: @Dices[0] + @Skill.Attribute + @Critvalue
    "Значение профессии"
    int exp ProfessionValue: @Dices[1] + @Skill.Profession.Modifier + @Critvalue
    "Значение навыка"
    int exp SkillValue: @Dices[2] + @Skill.Points + @Critvalue
    "Значения"
    list<int> exp Values: [@AttributeValue, @ProfessionValue, @SkillValue]
    "Класс"
    int exp Class: ceil(min(@Values) / 3)
    "Урон"
    int exp Damage: sum(filter(lamda d: d > 0, @Dices))
    "Цена"
    int exp Price: sum(filter(lamda d: d < 0, @Dices))
    "Результат"
    int exp Result: @Damage + @Price
    
"Бросок навыка"
func RollSkill:
    "Навык"
    ref<Skill> Skill
    "Результат броска"
    Roll return: { Skill: @Skill }
